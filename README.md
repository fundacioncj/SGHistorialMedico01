# SGHistorialMedico01 - Microservicio de Historia Cl√≠nica √önica

## üìÑ Descripci√≥n

Este microservicio implementa la gesti√≥n digital del **Formulario 002 CONSULTA EXTERNA 2021** del Sistema de Historia Cl√≠nica √önica (HCU) de Ecuador. El sistema digitaliza completamente el proceso de consulta externa m√©dica, siguiendo las normativas y est√°ndares del Ministerio de Salud P√∫blica del Ecuador.

## üèõÔ∏è Arquitectura

El proyecto implementa una **Arquitectura Hexagonal** (Puertos y Adaptadores) combinada con **Domain-Driven Design (DDD)**, garantizando separaci√≥n de responsabilidades, alta cohesi√≥n y bajo acoplamiento.

### üìÇ Estructura del Proyecto Refactorizada

```text
üèõÔ∏è ARQUITECTURA HEXAGONAL + DDD
‚îú‚îÄ‚îÄ üîµ DOMINIO (CORE BUSINESS)
‚îÇ   ‚îú‚îÄ‚îÄ üìã domain/consultaexterna/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üè¢ ConsultaExterna.java (Aggregate Root)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üíé valueobjects/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üî¢ enums/
‚îú‚îÄ‚îÄ üü° APLICACI√ìN (ORQUESTACI√ìN)
‚îÇ   ‚îú‚îÄ‚îÄ üì§ commands/ (Operaciones de escritura)
‚îÇ   ‚îú‚îÄ‚îÄ üì• queries/ (Operaciones de lectura)
‚îÇ   ‚îî‚îÄ‚îÄ üéØ handlers/ (Orquestaci√≥n de casos de uso)
‚îú‚îÄ‚îÄ üü¢ INFRAESTRUCTURA (ADAPTERS)
‚îÇ   ‚îú‚îÄ‚îÄ üåê rest/consultaexterna/
‚îÇ   ‚îú‚îÄ‚îÄ üóÑÔ∏è persistence/consultaexterna/
‚îÇ   ‚îî‚îÄ‚îÄ ‚öôÔ∏è config/
‚îî‚îÄ‚îÄ üìã DOCUMENTACI√ìN Y PRUEBAS/
    ‚îú‚îÄ‚îÄ üìÇ Collection-postman/ (Cuerpos de solicitud JSON y Colecci√≥n Postman)
    ‚îú‚îÄ‚îÄ üìú curl-suite.sh (Suite de pruebas de API)
    ‚îú‚îÄ‚îÄ üìú endpoints.json (Definici√≥n de API para m√°quinas)
    ‚îú‚îÄ‚îÄ üìú openapi.yaml (Especificaci√≥n OpenAPI 3.1.0)
    ‚îî‚îÄ‚îÄ üìú ENDPOINTS-REPORT.md (Reporte de API para humanos)
```

## üìã Mapeo del Formulario 002

El sistema mapea las secciones del formulario oficial a Objetos de Valor de dominio, asegurando una representaci√≥n digital fiel y validada.

| Secci√≥n | Descripci√≥n | `Value Object` Correspondiente | Estado |
|---------|-------------|--------------------------------|--------|
| A-B | Datos del Establecimiento y Paciente | `DatosFormulario`, `DatosPaciente` | ‚úÖ Implementado |
| C, E | Motivo y Enfermedad Actual | `Anamnesis` | ‚úÖ Implementado |
| G | Constantes Vitales | `SignosVitales` | ‚ö° Mejorado |
| H | Examen F√≠sico | `ExamenFisico` | ‚úÖ Implementado |
| I | Diagn√≥stico CIE-10 | `Diagnostico` | ‚úÖ Implementado |
| J-M | Plan, Interconsultas, Prescripciones | `PlanTratamiento`, `Interconsulta` | ‚ö° Mejorado |


## üåê API REST: Endpoints Validados

La siguiente tabla resume los endpoints expuestos por la API, los cuales han sido validados a trav√©s de an√°lisis de c√≥digo y pruebas de integraci√≥n.

| Verbo | Ruta | Descripci√≥n |
|-------|------|-------------|
| POST | `/api/v1/consultas-externas` | Crea una nueva consulta externa. |
| GET | `/api/v1/consultas-externas/{id}` | Obtiene una consulta por su ID √∫nico. |
| GET | `/api/v1/consultas-externas/paciente/{cedula}` | Busca el historial de consultas de un paciente por su c√©dula. |
| GET | `/api/v1/consultas-externas/numero/{numero}` | Busca una consulta por su n√∫mero de formulario. |
| GET | `/api/v1/consultas-externas/buscar` | Realiza una b√∫squeda avanzada por fechas, especialidad, etc. |
| PUT | `/api/v1/consultas-externas/{id}` | Actualiza una consulta existente. |
| DELETE| `/api/v1/consultas-externas/{id}` | Elimina una consulta (marcado l√≥gico). |

### üìé Ejemplos pr√°cticos (POST y GET)

> Basados en la colecci√≥n **SGHistorialMedico01.postman_collection.json** y el an√°lisis del proyecto (payloads y rutas coherentes con los DTOs y controladores).

#### POST ‚Äî Crear una consulta externa
`POST http://localhost:8081/api/v1/consultas-externas`  
Headers: `Content-Type: application/json`

```json
{
  "usuarioCreador": "admin.sistema",
  "datosFormulario": {
    "numeroFormulario": "HCU-002-2025-0001",
    "establecimiento": "Hospital General",
    "codigoEstablecimiento": "1234",
    "areaSalud": "Zona 8",
    "distrito": "Guayaquil",
    "canton": "Guayaquil",
    "provincia": "Guayas"
  },
  "datosPaciente": {
    "cedula": "0912345678",
    "numeroHistoriaClinica": "HCL-0001",
    "primerNombre": "Juan",
    "segundoNombre": "Carlos",
    "apellidoPaterno": "P√©rez",
    "apellidoMaterno": "G√≥mez",
    "fechaNacimiento": "1990-05-15",
    "sexo": "MASCULINO",
    "direccion": "Av. Principal 123",
    "telefono": "0991234567",
    "email": "juan.perez@example.com",
    "contactoEmergencia": "Mar√≠a P√©rez",
    "telefonoEmergencia": "0987654321"
  },
  "datosConsulta": {
    "numeroConsulta": "CE-2025-000123",
    "fechaConsulta": "2025-08-12T10:30:00",
    "especialidad": "Medicina Interna",
    "medicoTratante": "Dr. Jos√© Morales",
    "codigoMedico": "MED-123",
    "tipoConsulta": "PRIMERA_VEZ",
    "motivoConsulta": "Dolor tor√°cico de 2 d√≠as",
    "observaciones": "Paciente estable"
  },
  "anamnesis": {
    "enfermedadActual": "Dolor tor√°cico opresivo, irradiado a brazo izquierdo",
    "antecedentesPatologicosPersonales": "Hipertensi√≥n",
    "antecedentesPatologicosFamiliares": "Cardiopat√≠a en padre",
    "antecedentesQuirurgicos": "Apendicectom√≠a 2010",
    "antecedentesGinecoObstetricos": null,
    "habitos": {
      "fuma": false,
      "bebeAlcohol": false,
      "actividadFisica": "Moderada",
      "dieta": "Balanceada"
    },
    "medicamentosActuales": ["Enalapril 10mg"],
    "alergias": ["Penicilina"],
    "revisionSistemas": "Sin hallazgos relevantes",
    "observaciones": "Ninguna"
  },
  "examenFisico": {
    "signosVitales": {
      "presionArterial": "120/80",
      "frecuenciaCardiaca": 80,
      "frecuenciaRespiratoria": 16,
      "temperatura": 36.8,
      "saturacionOxigeno": 98
    },
    "examenGeneral": "Paciente consciente, orientado x3",
    "examenesRegionales": [
      {
        "region": "Torax",
        "descripcion": "Murmullo vesicular conservado",
        "hallazgos": [],
        "normal": true
      }
    ],
    "medidasAntropometricas": {
      "pesoKg": 75.0,
      "tallaM": 1.75,
      "imc": 24.5,
      "cinturaCm": 85.0,
      "caderaCm": 95.0
    }
  },
  "diagnosticos": [
    {
      "codigoCie10": "I20.0",
      "descripcion": "Angina inestable",
      "tipo": "PRINCIPAL",
      "observaciones": "Evaluar marcadores card√≠acos",
      "fechaDiagnostico": "2025-08-12T10:45:00",
      "severidad": "MODERADO",
      "requiereSeguimiento": true,
      "tiempoSeguimientoMeses": 3,
      "planSeguimiento": "Control en 3 meses",
      "manifestacionesClinicas": ["Dolor tor√°cico"],
      "factoresRiesgo": ["HTA"],
      "esCronico": false,
      "requiereInterconsulta": false
    }
  ],
  "planTratamiento": {
    "prescripciones": [
      {
        "medicamento": "Aspirina",
        "dosis": "100 mg",
        "frecuencia": "cada 24h",
        "viaAdministracion": "Oral",
        "duracionDias": 30,
        "indicaciones": "Tomar despu√©s de alimentos",
        "fechaPrescripcion": "2025-08-12",
        "cantidad": 30,
        "unidadMedida": "tabletas",
        "medicamentoGenerico": true
      }
    ],
    "indicacionesGenerales": ["Reposo relativo"],
    "citasSeguimiento": [
      {
        "fecha": "2025-09-12T09:00:00",
        "motivo": "Control",
        "urgente": false
      }
    ],
    "interconsultas": [],
    "recomendaciones": ["Dieta baja en sodio"],
    "planEducacional": "Educaci√≥n sobre factores de riesgo cardiovascular"
  }
}
```

**cURL equivalente:**
```bash
curl -X POST "http://localhost:8081/api/v1/consultas-externas"   -H "Content-Type: application/json"   --data-binary @Collection-postman/CrearConsultaExternaCommand.json
```

#### GET ‚Äî Consultar una consulta por ID
`GET http://localhost:8081/api/v1/consultas-externas/{id}`

**cURL:**
```bash
curl -X GET "http://localhost:8081/api/v1/consultas-externas/60f1a5c2e8f87a2b94c12345"
```

#### GET ‚Äî Consultar historial por c√©dula (con filtros opcionales)
`GET http://localhost:8081/api/v1/consultas-externas/paciente/{cedula}?fechaDesde=YYYY-MM-DD&fechaHasta=YYYY-MM-DD&pagina=0&tamanio=10`

**cURL:**
```bash
curl -G "http://localhost:8081/api/v1/consultas-externas/paciente/0912345678"   --data-urlencode "fechaDesde=2025-01-01"   --data-urlencode "fechaHasta=2025-12-31"   --data-urlencode "pagina=0"   --data-urlencode "tamanio=10"
```

> **Tip**: Si usas `server.servlet.context-path`, antepone el contexto a las rutas (p. ej., `/sg-historial/api/v1/...`).

## üöÄ Automatizaci√≥n y Herramientas de Desarrollo

Para facilitar el desarrollo y las pruebas, se han generado autom√°ticamente los siguientes artefactos:

*   **`ENDPOINTS-REPORT.md`**: Un informe detallado y legible de todos los endpoints, incluyendo par√°metros, formatos de datos y notas importantes sobre la configuraci√≥n.
*   **`endpoints.json`**: Una especificaci√≥n de la API en formato JSON, ideal para importar en herramientas como Postman o para alimentar generadores de clientes.
*   **`Collection-postman/*.json`**: Archivos JSON con ejemplos de cuerpos de solicitud (`payloads`) para crear y actualizar consultas, listos para ser usados en pruebas.
*   **`Collection-postman/SGHistorialMedico01.postman_collection.json`**: Colecci√≥n Postman completa y funcional para probar los endpoints.
*   **`openapi.yaml`**: Especificaci√≥n **OpenAPI 3.1.0** compatible con Swagger UI.
*   **`curl-suite.sh`**: Un script de shell con un conjunto de pruebas de integraci√≥n que invoca a todos los endpoints de la API. Es una herramienta excelente para realizar pruebas de regresi√≥n r√°pidas desde la l√≠nea de comandos.

### Uso de la Suite de Pruebas

Para ejecutar la suite de pruebas completa, aseg√∫rese de que el script tenga permisos de ejecuci√≥n y luego inv√≥quelo:
```bash
# Dar permisos de ejecuci√≥n (solo la primera vez)
chmod +x curl-suite.sh

# Crear (usa payload de Collections-postman/CrearConsultaExternaCommand.json)
./curl-suite.sh post_consultas_externas_min

# Obtener por ID
./curl-suite.sh get_consulta_por_id 60f1a5c2e8f87a2b94c12345

# Buscar por c√©dula (simple y con filtros)
./curl-suite.sh get_consultas_por_cedula_min 0912345678
./curl-suite.sh get_consultas_por_cedula_full 0912345678 2025-01-01 2025-12-31 0 10

# B√∫squeda avanzada
./curl-suite.sh get_consultas_buscar_min 2025-01-01 2025-12-31
./curl-suite.sh get_consultas_buscar_full 2025-01-01 2025-12-31 Cardiolog√≠a "Dr.%20Juan%20P√©rez" COMPLETADA 0 10

# Actualizar (usa Collections-postman/ActualizarConsultaExternaCommand.json)
./curl-suite.sh put_consulta_actualizar_min 60f1a5c2e8f87a2b94c12345

# Eliminar (l√≥gica)
./curl-suite.sh delete_consulta_min 60f1a5c2e8f87a2b94c12345 "Registro duplicado"
```

## üîß L√≥gica de Negocio Implementada

El sistema incluye reglas de negocio clave para mejorar la calidad de la atenci√≥n:

*   **Clasificaci√≥n Autom√°tica de Presi√≥n Arterial**: Basado en las gu√≠as actuales.
*   **Detecci√≥n de Alertas Cr√≠ticas**: Generaci√≥n de alertas autom√°ticas cuando los signos vitales est√°n en rangos peligrosos.
*   **Validaci√≥n de Integridad**: Uso de anotaciones de validaci√≥n para asegurar que los datos entrantes son completos y correctos antes de ser procesados.
*   **Auditor√≠a**: Registro autom√°tico de la creaci√≥n y modificaci√≥n de cada consulta.

## ‚öôÔ∏è Configuraci√≥n e √çndices

La persistencia se gestiona con **MongoDB**. Se han configurado los siguientes √≠ndices para optimizar el rendimiento de las consultas:
```javascript
db.consultas_externas.createIndex({"datosPaciente.cedula": 1});
db.consultas_externas.createIndex({"numeroConsulta": 1}, {unique: true});
db.consultas_externas.createIndex({"datosConsulta.fechaConsulta": -1});
```
El proyecto contiene archivos `application-{profile}.properties` para configurar la conexi√≥n a la base de datos y otros par√°metros para los entornos de `dev`, `test` y `prod`.

## üß™ Testing

El proyecto mantiene un alto est√°ndar de calidad a trav√©s de:

*   **Tests Unitarios**: Utilizando JUnit y Mockito para probar la l√≥gica de dominio de forma aislada.
*   **Tests de Integraci√≥n**: Con Spring Boot Test y Testcontainers para validar el flujo completo, incluyendo la capa de persistencia.
```bash
# Ejecutar todos los tests
./mvnw verify
```

## üìñ Documentaci√≥n API (en vivo)

La especificaci√≥n OpenAPI y la interfaz de usuario de Swagger se generan autom√°ticamente y est√°n disponibles en los siguientes endpoints una vez que la aplicaci√≥n est√° en ejecuci√≥n:

*   **Swagger UI**: `http://localhost:8081/swagger-ui.html`
*   **OpenAPI Spec (JSON)**: `http://localhost:8081/v3/api-docs`

---

### **Memoria T√©cnica: M√≥dulo de Consulta Externa SGHistorialMedico01**

#### **1. Resumen Ejecutivo**

El presente documento detalla la arquitectura, funcionalidades y estado de validaci√≥n del microservicio `SGHistorialMedico01`, con especial foco en el m√≥dulo de **Consulta Externa**. El sistema tiene como objetivo principal la digitalizaci√≥n completa y la gesti√≥n del **Formulario 002 de Consulta Externa** del sistema de Historia Cl√≠nica √önica (HCU) de Ecuador.

Tras un an√°lisis exhaustivo del c√≥digo fuente y la API REST, se ha verificado que el sistema no solo cumple con los requerimientos funcionales, sino que tambi√©n se adhiere a principios de dise√±o de software robustos. Se ha generado un conjunto completo de artefactos de documentaci√≥n y pruebas, incluyendo un informe detallado de endpoints, ejemplos de carga √∫til (payloads) y una suite de pruebas automatizadas con `curl`, asegurando la calidad y fiabilidad del servicio.

#### **2. Arquitectura y Dise√±o T√©cnico**

El microservicio se fundamenta en una **Arquitectura Hexagonal (Puertos y Adaptadores)**, un enfoque moderno que garantiza un excelente desacoplamiento entre la l√≥gica de negocio central y los componentes de infraestructura (p. ej., la API REST, la base de datos).

La arquitectura se complementa con principios de **Domain-Driven Design (DDD)** para modelar el complejo dominio m√©dico y mantener un alto grado de coherencia en los modelos de dominio y sus invariantes.

La estructura del proyecto refleja esta arquitectura de manera clara:

*   **Dominio (`domain`)**: Contiene el n√∫cleo del negocio, incluyendo el Agregado `ConsultaExterna`, los Objetos de Valor (`Value Objects`) que representan cada secci√≥n del formulario, y las reglas de negocio cr√≠ticas. Es la capa m√°s aislada y fundamental del sistema.
*   **Aplicaci√≥n (`application`)**: Orquesta los flujos de trabajo de los casos de uso, coordinando comandos y consultas sin exponer detalles de infraestructura.
*   **Infraestructura (`infrastructure`)**: Implementa los adaptadores para tecnolog√≠as externas. Incluye el controlador REST (`ConsultaExternaController`), la implementaci√≥n del repositorio con MongoDB (`MongoConsultaExternaRepositoryAdapter`) y la configuraci√≥n del servicio.

#### **3. An√°lisis Funcional: Digitalizaci√≥n del Formulario 002**

El sistema ha implementado con √©xito la digitalizaci√≥n de todas las secciones principales del Formulario 002 de Consulta Externa. Cada secci√≥n se ha mapeado a un Objeto de Valor espec√≠fico en el dominio, lo que asegura una representaci√≥n fiel y validada de los datos.

| Secci√≥n del Formulario | Objeto de Valor de Dominio (`Value Object`) | Estado Actual |
| :--- | :--- | :--- |
| Datos del Establecimiento | `DatosFormulario` / `DatosConsulta` | ‚úÖ Implementado |
| Datos del Paciente | `DatosPaciente` | ‚úÖ Implementado |
| Motivo y Enfermedad Actual | `Anamnesis` | ‚úÖ Implementado |
| Antecedentes y H√°bitos | `Anamnesis` | ‚úÖ Implementado |
| Constantes Vitales | `SignosVitales` | ‚ö° Mejorado |
| Examen F√≠sico | `ExamenFisico` | ‚úÖ Implementado |
| Diagn√≥stico (CIE-10) | `Diagnostico` | ‚úÖ Implementado |
| Plan de Tratamiento | `PlanTratamiento` | ‚úÖ Implementado |
| Interconsultas | `Interconsulta` | ‚ö° Mejorado |
| Prescripciones | `Prescripcion` | ‚úÖ Implementado |

Las secciones marcadas como **"Mejorado"** indican que el sistema no solo digitaliza los datos, sino que a√±ade l√≥gica de negocio de valor, como la clasificaci√≥n autom√°tica de la presi√≥n arterial o la gesti√≥n de estados para las interconsultas.

#### **4. Validaci√≥n y Documentaci√≥n de la API REST**

Se ha completado un proceso de validaci√≥n exhaustivo de la API REST expuesta por el sistema. Este proceso confirma que la implementaci√≥n se alinea con la definici√≥n de dise√±o y es robusta frente a entradas inv√°lidas.

1.  **Inspecci√≥n de Endpoints**: Se analizaron los controladores de Spring para identificar todas las rutas, verbos HTTP y DTOs asociados.
2.  **Generaci√≥n de Informe (`ENDPOINTS-REPORT.md`)**: Se cre√≥ un informe legible que resume cada endpoint, sus par√°metros, formatos de fecha, enumeraciones y si requiere autenticaci√≥n (actualmente no requerida).
3.  **Especificaci√≥n Estructurada (`endpoints.json`)**: Se gener√≥ un archivo JSON que detalla la API de forma estructurada, √∫til para la integraci√≥n con herramientas automatizadas.
4.  **Suite de Pruebas (`curl-suite.sh`)**: Se cre√≥ un script de shell con funciones para invocar cada endpoint de la API, utilizando ejemplos de datos (`Collections-postman/*.json`). Esta suite sirve como un conjunto de pruebas de regresi√≥n e integraci√≥n r√°pidas.
5.  **Refuerzo de Validaciones**: Se emplean anotaciones de validaci√≥n de Jakarta en los DTOs/Commands, asegurando la integridad de los datos en la capa de entrada de la API.

El an√°lisis confirma la existencia de los siguientes endpoints principales:

| Verbo | Ruta | Prop√≥sito |
| :--- | :--- | :--- |
| `POST` | `/api/v1/consultas-externas` | Crear una nueva consulta externa. |
| `GET` | `/api/v1/consultas-externas/{id}` | Obtener una consulta por su ID. |
| `GET` | `/api/v1/consultas-externas/paciente/{cedula}` | Buscar consultas por c√©dula de paciente. |
| `GET` | `/api/v1/consultas-externas/numero/{numero}` | Buscar consulta por su n√∫mero √∫nico. |
| `GET` | `/api/v1/consultas-externas/buscar` | B√∫squeda avanzada con filtros. |
| `PUT` | `/api/v1/consultas-externas/{id}` | Actualizar una consulta existente. |
| `DELETE`| `/api/v1/consultas-externas/{id}` | Eliminar una consulta. |

#### **5. L√≥gica de Negocio y Flujos de Proceso**

El sistema implementa flujos de negocio complejos que van m√°s all√° de la simple captura de datos, incorporando validaciones cl√≠nicas autom√°ticas.

*   **Flujo de Consulta Principal**: Diferencia entre consultas de primera vez y subsecuentes con validaciones acordes.
*   **Evaluaci√≥n de Signos Vitales**: Clasificaci√≥n autom√°tica de presi√≥n arterial y alertas cl√≠nicas.
*   **Gesti√≥n de Interconsultas**: Seguimiento de estados operativos para su trazabilidad.
*   **Auditor√≠a y Trazabilidad**: Registro de acciones relevantes con usuario/fecha.

#### **6. Infraestructura y Persistencia**

La persistencia de los datos se gestiona a trav√©s de una base de datos **MongoDB**. Se han definido y aplicado √≠ndices optimizados para las consultas m√°s frecuentes, como la b√∫squeda por c√©dula de paciente, n√∫mero de consulta y fechas, garantizando un rendimiento adecuado a escala. La configuraci√≥n del proyecto est√° preparada para distintos entornos (`dev`, `prod`), facilitando el despliegue y la gesti√≥n.


## üóÑÔ∏è Implementaci√≥n en MongoDB

### Base de datos y colecciones

- **Base de datos**: `historial_medico`
- **Colecci√≥n principal**: `consultas-externas`
- **Colecciones relacionadas (opcionales/auxiliares)**: `diagnostico`, `paciente`, `profesional`
- **Convenciones**
    - `_id`: `ObjectId`
    - Fechas: ISO-8601 (`date`/`dateTime`) ‚Äî ej. `2025-08-12T10:30:00Z`
    - Enums en **MAY√öSCULAS** (p. ej., `PRIMERA_VEZ`, `MASCULINO`, etc.)
    - Eliminaci√≥n **l√≥gica**: campos `eliminado:boolean`, `motivoEliminacion:string`, `fechaEliminacion:dateTime`

### Estructura del documento (ejemplo realista)

> Corresponde a lo que se observa en `historial_medico.consultas-externas` (MongoDB Compass) y a los DTOs usados por la API/colecci√≥n Postman.

```json
{
  "_id": "ObjectId('...')",
  "admisionId": "001",
  "institucionSistema": "SNS-MSP",
  "establecimientoSalud": "Hospital General IESS Quito Sur",
  "unicodigo": "HGIESS-QUITO-SUR-001",
  "numeroHistoriaClinica": "HC-2023-0012345",
  "numeroArchivo": "ARCH-2023-0012",
  "hoja": "1",
  "tipoConsulta": "PRIMERA",
  "motivoConsulta": "Dolor abdominal recurrente de 2 semanas de evoluci√≥n",

  "paciente": {
    "cedula": "0912345678",
    "numeroHistoriaClinica": "HCL-0001",
    "primerNombre": "Juan",
    "apellidoPaterno": "P√©rez",
    "fechaNacimiento": "1990-05-15",
    "sexo": "MASCULINO",
    "telefono": "0991234567"
  },

  "enfermedadActual": "Dolor en hipogastrio de tipo c√≥lico...",
  "cronologia": "Inici√≥ hace 2 semanas, intermitente",
  "localizacion": "Hipogastrio",
  "caracteristicas": "C√≥lico, no irradiado",
  "intensidad": "7/10",
  "frecuencia": "3-4 veces por d√≠a",
  "factoresAgravantes": "Ingesta de alimentos",

  "antecedentesPersonales": { "hta": true, "dm": false, "...": "..." },
  "antecedentesFamiliares": { "cardiopatia": true },

  "constantesVitales": [
    { "timestamp": "2025-08-12T10:30:00", "pa": "120/80", "fc": 80, "fr": 16, "temp": 36.8, "satO2": 98 }
  ],
  "revisionOrganos": { "...": "..." },

  "examenFisico": {
    "examenGeneral": "Consciente, orientado x3",
    "examenesRegionales": [
      { "region": "Torax", "descripcion": "Murmullo vesicular conservado", "normal": true }
    ],
    "medidasAntropometricas": { "pesoKg": 75, "tallaM": 1.75, "imc": 24.5 }
  },

  "diagnosticos": [
    { "codigoCie10": "I20.0", "descripcion": "Angina inestable", "tipo": "PRINCIPAL", "fechaDiagnostico": "2025-08-12T10:45:00" }
  ],

  "planTratamiento": {
    "prescripciones": [
      { "medicamento": "Aspirina", "dosis": "100 mg", "frecuencia": "cada 24h", "viaAdministracion": "Oral", "duracionDias": 30 }
    ],
    "indicacionesGenerales": ["Reposo relativo"],
    "citasSeguimiento": [{ "fecha": "2025-09-12T09:00:00", "motivo": "Control", "urgente": false }]
  },

  "profesional": { "medicoTratante": "Dr. Jos√© Morales", "codigoMedico": "MED-123", "especialidad": "Medicina Interna" },

  "numeroConsulta": "CE-2025-000123",
  "fechaConsulta": "2025-08-12T10:30:00",

  "fechaCreacion": "2025-08-12T10:40:00Z",
  "fechaActualizacion": "2025-08-12T11:00:00Z",
  "eliminado": false
}
```

### √çndices y unicidad

> Algunos existen ya; otros son **recomendados** para rendimiento.

```javascript
// B√∫squeda por c√©dula (GET /paciente/{cedula})
db.consultas_externas.createIndex({ "paciente.cedula": 1 });

// Unicidad de n√∫mero de consulta (GET /numero/{numero})
db.consultas_externas.createIndex({ "numeroConsulta": 1 }, { unique: true });

// Listado reciente
db.consultas_externas.createIndex({ "fechaConsulta": -1 });

// Filtros frecuentes en /buscar
db.consultas_externas.createIndex({ "profesional.medicoTratante": 1 });
db.consultas_externas.createIndex({ "profesional.especialidad": 1 });
db.consultas_externas.createIndex({ "diagnosticos.codigoCie10": 1 });
```

### Mapeo de endpoints ‚Üí operaciones MongoDB

| Endpoint | Operaci√≥n en MongoDB |
|---|---|
| `POST /api/v1/consultas-externas` | `insertOne` en `consultas-externas`; set `fechaCreacion` y `fechaActualizacion`. Valida unicidad de `numeroConsulta`. |
| `GET /api/v1/consultas-externas/{id}` | `findOne({ _id: ObjectId(id), eliminado: { $ne: true } })`. |
| `GET /api/v1/consultas-externas/paciente/{cedula}` | `find({ "paciente.cedula": cedula, fechaConsulta: {$gte: desde, $lte: hasta} })` + `sort({fechaConsulta:-1})` + paginaci√≥n (`skip/limit`). |
| `GET /api/v1/consultas-externas/numero/{numero}` | `findOne({ numeroConsulta: numero, eliminado: { $ne: true } })`. |
| `GET /api/v1/consultas-externas/buscar` | `find` con combinaci√≥n de filtros: `{ fechaConsulta: rango?, "profesional.especialidad":?, "profesional.medicoTratante":?, estado:? }`. |
| `PUT /api/v1/consultas-externas/{id}` | `findOneAndUpdate({ _id: ObjectId(id) }, { $set: {...}, $currentDate: { fechaActualizacion: true } })`. |
| `DELETE /api/v1/consultas-externas/{id}` | **Eliminaci√≥n l√≥gica**: `updateOne({ _id: ObjectId(id) }, { $set: { eliminado: true, motivoEliminacion, fechaEliminacion: now } })`. |

### Consultas frecuentes (shell/driver)

**Historial por c√©dula y rango de fechas (paginado):**
```javascript
const cedula = "0912345678";
const desde = new Date("2025-01-01");
const hasta = new Date("2025-12-31");
const pagina = 0, tamanio = 10;

db.consultas_externas
  .find({ "paciente.cedula": cedula, fechaConsulta: { $gte: desde, $lte: hasta }, eliminado: { $ne: true } })
  .project({ diagnosticos: { $slice: 1 }, planTratamiento: 0 }) // ejemplo de proyecci√≥n
  .sort({ fechaConsulta: -1 })
  .skip(pagina * tamanio)
  .limit(tamanio);
```

**B√∫squeda avanzada (especialidad + m√©dico + estado + fechas):**
```javascript
db.consultas_externas.find({
  fechaConsulta: { $gte: ISODate("2025-01-01T00:00:00Z"), $lte: ISODate("2025-12-31T23:59:59Z") },
  "profesional.especialidad": "Cardiolog√≠a",
  "profesional.medicoTratante": "Dr. Juan P√©rez",
  estado: "COMPLETADA",
  eliminado: { $ne: true }
}).sort({ fechaConsulta: -1 });
```

**Por n√∫mero de consulta (√∫nico):**
```javascript
db.consultas_externas.findOne({ numeroConsulta: "CE-2025-000123", eliminado: { $ne: true } });
```

### Relaci√≥n con la colecci√≥n Postman

- La colecci√≥n **`SGHistorialMedico01.postman_collection.json`** incluye peticiones que reflejan este modelo:
    - **POST** usa un payload completo (campos de paciente, enfermedad actual, examen f√≠sico, diagn√≥sticos y plan).
    - **GET** por **ID** y por **c√©dula** aplican los filtros/parametrizaci√≥n de paginaci√≥n (`pagina`, `tamanio`) y rango de fechas (`fechaDesde`, `fechaHasta`).
- Los ejemplos del README (POST/GET) son coherentes con ese archivo y con los controladores del proyecto.

### Configuraci√≥n en `application.properties` (referencia)

> Ajusta host/puerto/credenciales seg√∫n tu entorno.

```ini
# MongoDB (local)
spring.data.mongodb.uri=mongodb://localhost:27017/historial_medico
spring.data.mongodb.auto-index-creation=true

# Opcional: contexto y puerto de la app
server.port=8081
# server.servlet.context-path=/sg-historial
```

> **Buenas pr√°cticas recomendadas**
> - Mantener **√≠ndices** alineados a los par√°metros m√°s consultados por la API.
> - Auditar cambios: actualizar `fechaActualizacion` en cada `PUT`.
> - Evitar `deleteOne`: preferir **eliminaci√≥n l√≥gica** para trazabilidad.
> - Validar enumeraciones y formatos antes de insertar/actualizar (capas de DTO/servicio).